tile_mapper=
{
	["out-of-map"] = "out-of-map",

	--Deep water will kill the player to often
	["water"] = "water-shallow",
	["deepwater"] = "water-shallow",
	["water-green"] = "water-shallow",
	["deepwater-green"] = "water-shallow",
	["water-shallow"] = "water-shallow",
	["water-mud"] = "water-shallow",

	["mineral-purple-dirt-1"] = "mineral-white-dirt-5",
	["mineral-purple-dirt-2"] = "mineral-white-dirt-6",
	["mineral-purple-dirt-3"] = "mineral-white-dirt-4",
	["mineral-purple-dirt-4"] = "mineral-white-dirt-3",
	["mineral-purple-dirt-5"] = "mineral-white-dirt-1",
	["mineral-purple-dirt-6"] = "mineral-white-dirt-2",

	["mineral-violet-dirt-1"] = "mineral-dustyrose-dirt-3",
	["mineral-violet-dirt-2"] = "mineral-dustyrose-dirt-6",
	["mineral-violet-dirt-3"] = "mineral-dustyrose-dirt-1",
	["mineral-violet-dirt-4"] = "mineral-dustyrose-dirt-2",
	["mineral-violet-dirt-5"] = "mineral-dustyrose-dirt-4",
	["mineral-violet-dirt-6"] = "mineral-dustyrose-dirt-5",

	["mineral-red-dirt-1"] = "mineral-dustyrose-dirt-6",
	["mineral-red-dirt-2"] = "mineral-dustyrose-dirt-4",
	["mineral-red-dirt-3"] = "mineral-dustyrose-dirt-2",
	["mineral-red-dirt-4"] = "mineral-dustyrose-dirt-1",
	["mineral-red-dirt-5"] = "mineral-dustyrose-dirt-3",
	["mineral-red-dirt-6"] = "mineral-dustyrose-dirt-5",

	["mineral-brown-dirt-1"] = "mineral-brown-dirt-1",
	["mineral-brown-dirt-2"] = "mineral-brown-dirt-2",
	["mineral-brown-dirt-3"] = "mineral-brown-dirt-3",
	["mineral-brown-dirt-4"] = "mineral-brown-dirt-4",
	["mineral-brown-dirt-5"] = "mineral-brown-dirt-5",
	["mineral-brown-dirt-6"] = "mineral-brown-dirt-6",

	["mineral-tan-dirt-1"] = "mineral-tan-dirt-1",
	["mineral-tan-dirt-2"] = "mineral-tan-dirt-2",
	["mineral-tan-dirt-3"] = "mineral-tan-dirt-3",
	["mineral-tan-dirt-4"] = "mineral-tan-dirt-4",
	["mineral-tan-dirt-5"] = "mineral-tan-dirt-5",
	["mineral-tan-dirt-6"] = "mineral-tan-dirt-6",

	["mineral-aubergine-dirt-1"] = "mineral-tan-dirt-6",
	["mineral-aubergine-dirt-2"] = "mineral-tan-dirt-3",
	["mineral-aubergine-dirt-3"] = "mineral-tan-dirt-1",
	["mineral-aubergine-dirt-4"] = "mineral-tan-dirt-2",
	["mineral-aubergine-dirt-5"] = "mineral-tan-dirt-5",
	["mineral-aubergine-dirt-6"] = "mineral-tan-dirt-4",

	["mineral-dustyrose-dirt-1"] = "mineral-dustyrose-dirt-1",
	["mineral-dustyrose-dirt-2"] = "mineral-dustyrose-dirt-2",
	["mineral-dustyrose-dirt-3"] = "mineral-dustyrose-dirt-3",
	["mineral-dustyrose-dirt-4"] = "mineral-dustyrose-dirt-4",
	["mineral-dustyrose-dirt-5"] = "mineral-dustyrose-dirt-5",
	["mineral-dustyrose-dirt-6"] = "mineral-dustyrose-dirt-6",

	["mineral-tan-dirt-1"] = "mineral-tan-dirt-6",
	["mineral-tan-dirt-2"] = "mineral-tan-dirt-2",
	["mineral-tan-dirt-3"] = "mineral-tan-dirt-1",
	["mineral-tan-dirt-4"] = "mineral-tan-dirt-3",
	["mineral-tan-dirt-5"] = "mineral-tan-dirt-4",
	["mineral-tan-dirt-6"] = "mineral-tan-dirt-5",

	["mineral-cream-dirt-1"] = "mineral-grey-dirt-6",
	["mineral-cream-dirt-2"] = "mineral-grey-dirt-4",
	["mineral-cream-dirt-3"] = "mineral-grey-dirt-1",
	["mineral-cream-dirt-4"] = "mineral-grey-dirt-2",
	["mineral-cream-dirt-5"] = "mineral-grey-dirt-5",
	["mineral-cream-dirt-6"] = "mineral-grey-dirt-3",

	["mineral-black-dirt-1"] = "mineral-black-dirt-1",
	["mineral-black-dirt-2"] = "mineral-black-dirt-2",
	["mineral-black-dirt-3"] = "mineral-black-dirt-3",
	["mineral-black-dirt-4"] = "mineral-black-dirt-4",
	["mineral-black-dirt-5"] = "mineral-black-dirt-5",
	["mineral-black-dirt-6"] = "mineral-black-dirt-6",

	["mineral-grey-dirt-1"] = "mineral-grey-dirt-1",
	["mineral-grey-dirt-2"] = "mineral-grey-dirt-2",
	["mineral-grey-dirt-3"] = "mineral-grey-dirt-3",
	["mineral-grey-dirt-4"] = "mineral-grey-dirt-4",
	["mineral-grey-dirt-5"] = "mineral-grey-dirt-5",
	["mineral-grey-dirt-6"] = "mineral-grey-dirt-6",

	["mineral-white-dirt-1"] = "mineral-brown-dirt-4",
	["mineral-white-dirt-2"] = "mineral-brown-dirt-1",
	["mineral-white-dirt-3"] = "mineral-brown-dirt-3",
	["mineral-white-dirt-4"] = "mineral-brown-dirt-5",
	["mineral-white-dirt-5"] = "mineral-brown-dirt-2",
	["mineral-white-dirt-6"] = "mineral-brown-dirt-6",


	["mineral-purple-sand-1"] = "caveground",
	["mineral-purple-sand-2"] = "caveground",
	["mineral-purple-sand-3"] = "caveground",

	["mineral-violet-sand-1"] = "caveground",
	["mineral-violet-sand-2"] = "caveground",
	["mineral-violet-sand-3"] = "caveground",

	["mineral-red-sand-1"] = "mineral-grey-dirt-1",
	["mineral-red-sand-2"] = "mineral-grey-dirt-4",
	["mineral-red-sand-3"] = "mineral-grey-dirt-6",

	["mineral-brown-sand-1"] = "mineral-grey-dirt-2",
	["mineral-brown-sand-2"] = "mineral-grey-dirt-3",
	["mineral-brown-sand-3"] = "mineral-grey-dirt-5",

	["mineral-tan-sand-1"] = "mineral-tan-dirt-1",
	["mineral-tan-sand-2"] = "mineral-tan-dirt-2",
	["mineral-tan-sand-3"] = "mineral-tan-sand-2",

	["mineral-aubergine-sand-1"] = "mineral-tan-dirt-1",
	["mineral-aubergine-sand-2"] = "mineral-tan-dirt-6",
	["mineral-aubergine-sand-3"] = "mineral-tan-dirt-2",

	["mineral-dustyrose-sand-1"] = "mineral-dustyrose-dirt-1",
	["mineral-dustyrose-sand-2"] = "mineral-dustyrose-sand-2",
	["mineral-dustyrose-sand-3"] = "mineral-dustyrose-dirt-5",

	["mineral-beige-sand-1"] = "mineral-tan-dirt-3",
	["mineral-beige-sand-2"] = "mineral-tan-dirt-2",
	["mineral-beige-sand-3"] = "mineral-tan-dirt-4",

	["mineral-cream-sand-1"] = "mineral-grey-dirt-1",
	["mineral-cream-sand-2"] = "mineral-grey-sand-2",
	["mineral-cream-sand-3"] = "mineral-grey-dirt-4",

	["mineral-black-sand-1"] = "mineral-black-dirt-1",
	["mineral-black-sand-2"] = "mineral-black-sand-2",
	["mineral-black-sand-3"] = "mineral-black-dirt-4",

	["mineral-grey-sand-1"] = "mineral-grey-dirt-6",
	["mineral-grey-sand-2"] = "mineral-grey-sand-2",
	["mineral-grey-sand-3"] = "mineral-grey-dirt-5",

	["mineral-white-sand-1"] = "mineral-brown-sand-2",
	["mineral-white-sand-2"] = "mineral-brown-sand-2",
	["mineral-white-sand-3"] = "mineral-brown-sand-3",

	["vegetation-green-grass-1"] = "mineral-tan-dirt-1",
	["vegetation-green-grass-2"] = "mineral-tan-dirt-3",
	["vegetation-green-grass-3"] = "mineral-tan-dirt-2",
	["vegetation-green-grass-4"] = "mineral-tan-dirt-5",

	["vegetation-olive-grass-1"] = "mineral-tan-dirt-1",
	["vegetation-olive-grass-2"] = "mineral-tan-dirt-1",

	["vegetation-yellow-grass-1"] = "mineral-grey-dirt-2",
	["vegetation-yellow-grass-2"] = "mineral-grey-dirt-2",

	["vegetation-orange-grass-1"] = "mineral-brown-dirt-3",
	["vegetation-orange-grass-2"] = "mineral-brown-dirt-5",

	["vegetation-violet-grass-1"] = "mineral-black-dirt-4",
	["vegetation-violet-grass-2"] = "mineral-black-dirt-6",

	["vegetation-purple-grass-1"] = "mineral-brown-dirt-5",
	["vegetation-purple-grass-2"] = "mineral-brown-dirt-1",

	["vegetation-mauve-grass-1"] = "caveground",
	["vegetation-mauve-grass-2"] = "caveground",

	["vegetation-blue-grass-1"] = "caveground",
	["vegetation-blue-grass-2"] = "caveground",

	["vegetation-turquoise-grass-1"] = "mineral-dustyrose-dirt-3",
	["vegetation-turquoise-grass-2"] = "mineral-dustyrose-dirt-4",

	["volcanic-orange-heat-1"] = "volcanic-orange-heat-1",
	["volcanic-orange-heat-2"] = "volcanic-orange-heat-2",
	["volcanic-orange-heat-3"] = "volcanic-orange-heat-3",
	["volcanic-orange-heat-4"] = "volcanic-orange-heat-4",

	["volcanic-green-heat-1"] = "volcanic-orange-heat-1",
	["volcanic-green-heat-2"] = "volcanic-orange-heat-2",
	["volcanic-green-heat-3"] = "volcanic-orange-heat-4",
	["volcanic-green-heat-4"] = "volcanic-orange-heat-4",

	["volcanic-blue-heat-1"] = "volcanic-orange-heat-1",
	["volcanic-blue-heat-2"] = "volcanic-orange-heat-2",
	["volcanic-blue-heat-3"] = "volcanic-orange-heat-3",
	["volcanic-blue-heat-4"] = "volcanic-orange-heat-4",

	["volcanic-purple-heat-1"] = "volcanic-orange-heat-1",
	["volcanic-purple-heat-2"] = "volcanic-orange-heat-2",
	["volcanic-purple-heat-3"] = "volcanic-orange-heat-3",
	["volcanic-purple-heat-4"] = "volcanic-orange-heat-4",

	["frozen-snow-0"] = "mineral-grey-dirt-3",
	["frozen-snow-1"] = "mineral-grey-dirt-1",
	["frozen-snow-2"] = "mineral-grey-dirt-2",
	["frozen-snow-3"] = "mineral-grey-dirt-4",
	["frozen-snow-4"] = "mineral-grey-dirt-6",

	["frozen-snow-5"] = "frozen-snow-5",
	["frozen-snow-6"] = "frozen-snow-6",
	["frozen-snow-7"] = "frozen-snow-7",
	["frozen-snow-8"] = "frozen-snow-8",
	["frozen-snow-9"] = "frozen-snow-9"

}

water_tiles=
{
	["water"] = 1,
	["deepwater"] = 1,
	["water-green"] = 1,
	["deepwater-green"] = 1,
	["water-shallow"] = 1,
	["water-mud"] = 1
}

function get_tile_replacement(tile_name)
	if tile_mapper[tile_name] then
		return tile_mapper[tile_name]
	else
		return "caveground"
	end
end

function is_water_tile(tile_name)
	if water_tiles[tile_name] then
		return true
	else
		return false
	end
end

local meta = {
	__index = function(self, key) return {size = 0, frequency = 0, richness = 0} end,
	__newindex = function(self, key, value)
		if game.autoplace_control_prototypes[key] then rawset(self, key, value) end
	end,
}

-- This is for subsurfaces, it returns a freshly new autoplace_controls array
-- depth is always >= 1
function make_autoplace_controls(topname, depth)
	local res_table = {}
	setmetatable(res_table, meta)
	
	size_factor = settings.global["resource-size-offset"].value * (settings.global["resource-size-factor"].value ^ (depth - 1))
	richness_factor = settings.global["resource-richness-offset"].value * (settings.global["resource-richness-factor"].value ^ (depth - 1))
	frequency_factor = settings.global["resource-frequency-offset"].value * (settings.global["resource-frequency-factor"].value ^ (depth - 1))
	
	for res,control in pairs(game.get_surface(topname).map_gen_settings.autoplace_controls or {}) do
		res_table[res] = {
			frequency = control.frequency * frequency_factor,
			size = control.size * size_factor,
			richness = control.richness * richness_factor,
		}
	end

	res_table["stone"].size = res_table["stone"].size * 0.5

	res_table["trees"].size = 0
	res_table["trees"].frequency = 0

	res_table["enemy-base"].size = 0
	res_table["enemy-base"].frequency = 0

	res_table["hot"].size = 0.25
	res_table["hot"].frequency = 2.0

	res_table["cold"].size = 0.25
	res_table["cold"].frequency = 2.0

	return res_table
end


function make_subsurface(parent_surface)
	local subsurface_name = ""
	local _, _, topname, depth = string.find(parent_surface.name, "(.+)_subsurface_([0-9]+)$")
	if topname == nil then -- surface is not a subsurface
		topname = parent_surface.name
		depth = 1
	else
		depth = tonumber(depth) + 1
	end
	subsurface_name = topname .. "_subsurface_" .. depth
	
	local subsurface = game.get_surface(subsurface_name)
	if subsurface then
		log("Warning: attemt to create subsurface, but surface was already existing!")
	else
		local mgs = {
			--configure map generator
			seed = parent_surface.map_gen_settings.seed + 9556 * depth,
			width = parent_surface.map_gen_settings.width,
			height = parent_surface.map_gen_settings.height,
			terrain_segmentation = 12,
			water = 0.2,
			starting_area = 0,
			peaceful_mode = parent_surface.map_gen_settings.peaceful_mode,
			autoplace_controls = make_autoplace_controls(topname, depth),
			autoplace_settings =
			{
			  	decorative = {treat_missing_as_default = false, settings = 
			  	{
					["rock-small"] = {},
					["rock-tiny"] = {}
				}},
			},
			property_expression_names = --parent_surface.map_gen_settings.property_expression_names
			{ -- priority is from top to bottom
				["control-setting:aux:frequency:multiplier"] = 1.4,
				["control-setting:aux:bias"] = 0.1,
				["control-setting:moisture:frequency:multiplier"] = 0.8,
				["control-setting:moisture:bias"] = 0.0,

				["decorative:rock-small:probability"] = 0.4,
				["decorative:rock-tiny:probability"] = 0.7,
			}
		}

		--TODO Prevent water on arid SE planets

		subsurface = game.create_surface(subsurface_name, mgs)

		subsurface.daytime = 0.5
		subsurface.freeze_daytime = true
		subsurface.show_clouds = false
		
		if remote.interfaces["blackmap"] then remote.call("blackmap", "register", subsurface) end
		
		global.enemies_above_exposed_underground[parent_surface.index] = {}
		
	end
	global.subsurfaces[parent_surface.index] = subsurface
	global.exposed_chunks[subsurface.index] = global.exposed_chunks[subsurface.index] or {}
	return subsurface
end


